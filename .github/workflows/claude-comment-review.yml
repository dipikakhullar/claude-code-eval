name: Claude PR Comment Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  id-token: write

concurrency:
  group: claude-review-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  review:
    timeout-minutes: 12
    # Only run for PR comments that mention @claude
    if: contains(github.event.comment.body, '@claude') && (github.event_name == 'pull_request_review_comment' || (github.event_name == 'issue_comment' && github.event.issue.pull_request != null))
    runs-on: ubuntu-latest

    steps:
      # 1) Check out repo with FULL history
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Resolve the PR number for either event shape
      - name: Derive PR number
        id: prnum
        shell: bash
        run: |
          PR="${{ github.event.pull_request.number }}"
          if [ -z "$PR" ] || [ "$PR" = "null" ]; then
            PR="${{ github.event.issue.number }}"
          fi
          if ! [[ "$PR" =~ ^[0-9]+$ ]]; then
            echo "Could not determine PR number"; exit 1
          fi
          echo "pr=$PR" >> "$GITHUB_OUTPUT"

      # 3) Check out the PR HEAD so local git diffs match the PR (prevents HEAD~1 errors)
      - name: Checkout PR head
        shell: bash
        run: |
          PR="${{ steps.prnum.outputs.pr }}"
          git fetch origin "pull/$PR/head:pr-$PR"
          git checkout "pr-$PR"
          git log --oneline -3

      # 4) (Optional) Get the list of changed files in the PR (we’ll pass it to Claude via prompt)
      - name: Determine changed files
        id: changes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          PR="${{ steps.prnum.outputs.pr }}"
          files=$(gh pr view "$PR" --json files --jq '.files[].path' | tr '\n' ' ' || true)
          echo "files=$files" >> "$GITHUB_OUTPUT"

      # 5) Preflight: verify we can post to the PR
      - name: Preflight - can post a PR comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          PR="${{ steps.prnum.outputs.pr }}"
          gh pr comment "$PR" --body ":rocket: Claude review starting..."

      # 6) (Optional) tiny speed-up for Bun runtime used by the action
      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: ~/.bun
          key: bun-1.2.11

      # 7) Run Claude Code to review ONLY the PR diff
      - name: Run Claude Code Action
        id: claude
        uses: anthropics/claude-code-action@v1.0.6
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Ask this build to emit PR comments if supported; we also post a summary below
          claude_args: "--pr-comments"
          prompt: |
            You are reviewing a GitHub pull request. Focus on correctness and security.
            - Review only the PR's changed files: ${{ steps.changes.outputs.files }}
            - Do not comment on files outside the PR.
            - If changes look good and low risk, post: "✅ LGTM. Approved for merge."
            - Otherwise, leave concise inline comments explaining what must be fixed.

      # 8) Post Claude's summary report to the PR (some builds only save to a temp JSON)
      - name: Post Claude report to PR
        if: always()  # still post even if previous step returns nonzero
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          PR="${{ steps.prnum.outputs.pr }}"
          REPORT_JSON="/home/runner/work/_temp/claude-execution-output.json"
          if [ -f "$REPORT_JSON" ]; then
            body=$(jq -r '.result' "$REPORT_JSON")
            if [ -n "$body" ] && [ "$body" != "null" ]; then
              gh pr comment "$PR" --body "$body"
            else
              echo "Claude report empty; skipping."
            fi
          else
            echo "No Claude report found; skipping."
          fi

      # 9) OPTIONAL: auto-approve only if a maintainer adds 'auto-approve' label
      - name: Approve PR (label-gated)
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_REVIEW }}  # PAT: Classic(repo) OR Fine-grained(Contents:Read, Pull requests:Write)
        shell: bash
        run: |
          PR="${{ steps.prnum.outputs.pr }}"
          has_label=$(gh pr view "$PR" --json labels --jq '.labels[].name' | grep -Fx "auto-approve" || true)
          if [ -z "$has_label" ]; then
            echo "No 'auto-approve' label; skipping approval."; exit 0
          fi
          gh pr review "$PR" --approve --body "Auto-approved after Claude review."
