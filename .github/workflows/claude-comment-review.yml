name: Claude PR Comment Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  id-token: write

concurrency:
  group: claude-review-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  review:
    timeout-minutes: 12
    if: contains(github.event.comment.body, '@claude') && (github.event_name == 'pull_request_review_comment' || (github.event_name == 'issue_comment' && github.event.issue.pull_request != null))
    runs-on: ubuntu-latest
    steps:
      # 1) Full history so HEAD~1 diffs work
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Derive PR number for either event shape
      - name: Derive PR number
        id: prnum
        shell: bash
        run: |
          PR="${{ github.event.pull_request.number }}"
          if [ -z "$PR" ] || [ "$PR" = "null" ]; then
            PR="${{ github.event.issue.number }}"
          fi
          if ! [[ "$PR" =~ ^[0-9]+$ ]]; then
            echo "Could not determine PR number"; exit 1
          fi
          echo "pr=$PR" >> "$GITHUB_OUTPUT"

      # 3) Check out the PR head so we diff the actual PR, not main
      - name: Checkout PR head
        shell: bash
        run: |
          PR="${{ steps.prnum.outputs.pr }}"
          git fetch origin "pull/$PR/head:pr-$PR"
          git checkout "pr-$PR"
          git log --oneline -3

      # 4) Get changed files (to pass to prompt)
      - name: Determine changed files
        id: changes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          PR="${{ steps.prnum.outputs.pr }}"
          files=$(gh pr view "$PR" --json files --jq '.files[].path' | tr '\n' ' ' || true)
          echo "files=$files" >> "$GITHUB_OUTPUT"

      # 5) Preflight comment (confirms perms)
      - name: Preflight - can post a PR comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          PR="${{ steps.prnum.outputs.pr }}"
          gh pr comment "$PR" --body ":rocket: Claude review starting..."

      # 6) (Optional) speed-up for Bun
      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: ~/.bun
          key: bun-1.2.11

      # 7) Run Claude Code (no --pr-comments; this build writes a report JSON)
      - name: Run Claude Code Action
        id: claude
        uses: anthropics/claude-code-action@v1.0.6
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            You are reviewing a GitHub pull request. Focus on correctness and security.
            - Review only these changed files: ${{ steps.changes.outputs.files }}
            - Do not comment on files outside the PR.
            - If changes look good and low risk, say: "âœ… LGTM. Approved for merge."
            - Otherwise, list concise issues that must be fixed.

      # 8) Post Claude's summary back to the PR from the saved JSON
      - name: Post Claude report to PR
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          PR="${{ steps.prnum.outputs.pr }}"
          REPORT_JSON="/home/runner/work/_temp/claude-execution-output.json"

          if [ ! -f "$REPORT_JSON" ]; then
            echo "No Claude report found at $REPORT_JSON; skipping."
            exit 0
          fi

          # Try object shape first: { "result": "..." }
          if jq -e 'type=="object" and has("result")' "$REPORT_JSON" >/dev/null 2>&1; then
            BODY="$(jq -r '.result' "$REPORT_JSON")"
          # Else handle array-of-turns shape
          elif jq -e 'type=="array"' "$REPORT_JSON" >/dev/null 2>&1; then
            # Pull any final 'result' fields, or concatenate assistant text chunks
            BODY="$(jq -r '
              [
                .[] | .result?,
                (.[]?.message?.content[]? | select(.type=="text") | .text?)
              ]
              | map(select(.!=null)) | join("\n\n")
            ' "$REPORT_JSON")"
          else
            BODY=""
          fi

          # Fallback: dump a truncated JSON block if we couldn't extract text
          if [ -z "${BODY:-}" ] || [ "$BODY" = "null" ]; then
            echo "Structured body empty; posting truncated raw JSON."
            BODY="(Claude report attached)\n\n\`\`\`json\n$(head -c 60000 "$REPORT_JSON")\n\`\`\`"
          fi

          gh pr comment "$PR" --body "$BODY"

      # 9) OPTIONAL: auto-approve only when maintainers add the label
      - name: Approve PR (label-gated)
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_REVIEW }}  # PAT with repo scope (or fine-grained: Contents:Read, Pull requests:Write)
        shell: bash
        run: |
          PR="${{ steps.prnum.outputs.pr }}"
          has_label=$(gh pr view "$PR" --json labels --jq '.labels[].name' | grep -Fx "auto-approve" || true)
          if [ -z "$has_label" ]; then
            echo "No 'auto-approve' label; skipping approval."; exit 0
          fi
          gh pr review "$PR" --approve --body "Auto-approved after Claude review."
