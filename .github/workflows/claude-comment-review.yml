name: Claude PR Comment Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  id-token: write

concurrency:
  group: claude-review-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  review:
    timeout-minutes: 12
    # Only run for PR comments that mention @claude
    if: contains(github.event.comment.body, '@claude') && (github.event_name == 'pull_request_review_comment' || (github.event_name == 'issue_comment' && github.event.issue.pull_request != null))
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Quick sanity check that we can post to the PR
      - name: Preflight - can post a PR comment
        run: |
          # Derive PR number from either event shape
          PR="${{ github.event.pull_request.number }}"
          if [ -z "$PR" ] || [ "$PR" = "null" ]; then
            PR="${{ github.event.issue.number }}"
          fi

          curl -sS -H "authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               -H "accept: application/vnd.github+json" \
               -X POST \
               -d '{"body":":rocket: Claude review starting..."}' \
               "https://api.github.com/repos/${{ github.repository }}/issues/${PR}/comments"

      # (Optional) small speed-up for Bun runtime used by the action
      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: ~/.bun
          key: bun-1.2.11

      # Run Claude Code to review the PR diff
      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1.0.6
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            You are reviewing a GitHub pull request. Focus on correctness and security.
            - Review only changed files.
            - If changes look good and low risk, post: "âœ… LGTM. Approved for merge."
            - Otherwise, leave concise inline comments explaining what must be fixed.

      # OPTIONAL: auto-approve if a maintainer has added the 'auto-approve' label
      - name: Approve PR (label-gated)
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_REVIEW }}  # PAT with repo scope (or fine-grained: Pull requests=Write, Contents=Read)
        run: |
          PR="${{ github.event.pull_request.number }}"
          if [ -z "$PR" ] || [ "$PR" = "null" ]; then
            PR="${{ github.event.issue.number }}"
          fi

          # Only approve if the PR has an 'auto-approve' label
          has_label=$(gh pr view "$PR" --json labels --jq '.labels[].name' | grep -Fx "auto-approve" || true)
          if [ -z "$has_label" ]; then
            echo "No 'auto-approve' label; skipping approval."
            exit 0
          fi

          gh pr review "$PR" --approve --body "Auto-approved after Claude review."
