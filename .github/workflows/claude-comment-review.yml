name: Claude PR Comment Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  review:
    timeout-minutes: 12
    if: contains(github.event.comment.body, '@claude') && (github.event_name == 'pull_request_review_comment' || (github.event_name == 'issue_comment' && github.event.issue.pull_request != null))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 0) (Optional) more verbose runner logs
      - name: Enable step debug (needs repo secret ACTIONS_STEP_DEBUG=true)
        if: ${{ secrets.ACTIONS_STEP_DEBUG }}
        run: echo "Step debug is on"

      # 1) Verify your Anthropic key actually works from the runner
      - name: Sanity check Anthropic API key
        run: |
          set -euo pipefail
          echo 'Calling Anthropic...'
          resp="$(curl -sS https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d '{"model":"claude-3-5-sonnet-20240620","max_tokens":8,"messages":[{"role":"user","content":"ping"}]}' )"
          echo "OK. Truncated response:"
          echo "$resp" | head -c 300
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      # 2) Verify we can post to the PR (permissions/token)
      - name: Can post a PR comment?
        if: ${{ github.event_name == 'pull_request_review_comment' || (github.event_name == 'issue_comment' && github.event.issue.pull_request != null) }}
        run: |
          pr_number="${{ github.event.issue.number || github.event.pull_request.number }}"
          curl -sS -H "authorization: Bearer $GH_TOKEN" \
               -H "accept: application/vnd.github+json" \
               -X POST \
               -d "{\"body\":\":white_check_mark: GitHub token can post comments (preflight).\"}" \
               "https://api.github.com/repos/${{ github.repository }}/issues/${pr_number}/comments"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 3) (Optional) small speed-up
      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: ~/.bun
          key: bun-1.2.11

      # 4) Run Claude Code
      - name: Run Claude Code Action (comment-triggered)
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            You are reviewing a GitHub pull request. Focus on security, correctness, and clarity.
            - Only comment on files that changed in this PR.
            - Prioritize actionable fixes and cite specific lines.
            - Keep comments concise; avoid restating code.
